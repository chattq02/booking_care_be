// =========================
// BẢNG LỊCH KHÁM (APPOINTMENT)
// =========================

// Trạng thái của cuộc hẹn khám
enum AppointmentStatus {
  PENDING // Chờ xác nhận
  CONFIRMED // Đã xác nhận
  COMPLETED // Đã hoàn thành
  CANCELED // Đã hủy
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

model Appointment {
  id            Int               @id @default(autoincrement()) // Khóa chính
  uuid          String            @unique @default(uuid()) // Mã định danh duy nhất

  doctorId      Int // FK: Id của bác sĩ (User có role=DOCTOR)
  patientId     Int // FK: Id của bệnh nhân (User có role=PATIENT)
  scheduleId    Int // FK: Id của ca khám (Schedule)
  facilityId    Int // FK: Id của cơ sở y tế (MedicalFacility)
  paymentStatus PaymentStatus     @default(UNPAID)
  attachments   Json?
  paymentAmount Float?
  status        AppointmentStatus @default(PENDING) // Trạng thái của lịch khám
  note          String? // Ghi chú thêm từ bệnh nhân / bác sĩ
  appointmentDate String        // THÊM MỚI: Ngày đặt lịch khám (ngày thực tế của cuộc hẹn)
    slot        Json           @default("{}") // THÊM MỚI: Thời gian đặt lịch khám (thời gian thực tế của cuộc hẹn)

  // Quan hệ
  doctor       User            @relation("DoctorAppointments", fields: [doctorId], references: [id], onDelete: Cascade)
  patient      User            @relation("PatientAppointments", fields: [patientId], references: [id], onDelete: Cascade)
  schedule     Schedule        @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  facility     MedicalFacility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  prescription Prescription?   @relation("AppointmentToPrescription") // Mối quan hệ 1-1 với đơn thuốc

  createdAt DateTime @default(now()) // Thời gian tạo bản ghi
  updatedAt DateTime @updatedAt // Cập nhật khi thay đổi

  @@index([facilityId, status]) // Index cho truy vấn theo cơ sở và trạng thái
  @@index([facilityId, createdAt]) // Index cho thống kê theo thời gian
  @@index([appointmentDate]) // THÊM MỚI: Index cho truy vấn theo ngày khám
  @@index([patientId, appointmentDate]) // THÊM MỚI: Index cho lịch sử khám của bệnh nhân
  @@map("appointments") // Tên bảng trong DB
}